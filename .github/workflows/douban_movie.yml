name: douban movie sync

on:
  workflow_dispatch:
  schedule:
    - cron: "0 14 * * *"
    - cron: "0 22 * * *"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sync:
    name: Sync Douban Movies
    runs-on: ubuntu-latest
    env:
      MOVIE_NOTION_TOKEN: ${{ secrets.MOVIE_NOTION_TOKEN }}
      NOTION_MOVIE_URL: ${{ secrets.NOTION_MOVIE_URL }}
      DOUBAN_NAME: ${{ secrets.DOUBAN_NAME }}
      MOVIE_NAME: ${{ secrets.MOVIE_NAME }}
      BACKGROUND_COLOR: ${{ vars.BACKGROUND_COLOR || '#FFFFFF' }}
      TRACK_COLOR: ${{ vars.TRACK_COLOR || '#ACE7AE' }}
      SPECIAL_COLOR: ${{ vars.SPECIAL_COLOR || '#69C16E' }}
      SPECIAL_COLOR2: ${{ vars.SPECIAL_COLOR2 || '#549F57' }}
      DOM_COLOR: ${{ vars.DOM_COLOR || '#EBEDF0' }}
      TEXT_COLOR: ${{ vars.TEXT_COLOR || '#000000' }}
      YEAR: ${{ vars.YEAR || '$(date +"%Y")' }}
      REF: ${{ github.ref }}
      REPOSITORY: ${{ github.repository }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set Up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: 3.9

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Sync Douban Movie Data
        run: douban "movie"

      - name: Generate Notion Heatmap
        run: |
          github_heatmap notion \
            --notion_token "${{ secrets.MOVIE_NOTION_TOKEN }}" \
            --database_id "${{ env.DATABASE_ID }}" \
            --date_prop_name "日期" \
            --value_prop_name "看过" \
            --unit "部" \
            --year $YEAR \
            --me "${{ secrets.MOVIE_NAME }}" \
            --without-type-name \
            --background-color=${{ env.BACKGROUND_COLOR }} \
            --track-color=${{ env.TRACK_COLOR }} \
            --special-color1=${{ env.SPECIAL_COLOR }} \
            --special-color2=${{ env.SPECIAL_COLOR2 }} \
            --dom-color=${{ env.DOM_COLOR }} \
            --text-color=${{ env.TEXT_COLOR }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "latest"
          name: "Latest Heatmap"
          files: ./OUT_FOLDER/movie/*.svg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Notion with Heatmap URL
        run: update_heatmap.py "movie"

      - name: Final Git Push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add OUT_FOLDER/movie/*.svg
          git commit -m 'Add new heatmap' || echo "Nothing to commit"
          git pull --rebase origin main
          git push || echo "Nothing to push"
